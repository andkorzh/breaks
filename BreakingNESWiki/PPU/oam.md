# OAM

Спрайтовая память (OAM, Object RAM) занимает почти четверть поверхности PPU, в те времена память была роскошью. Размер OAM составляет 2112 разрядов, из них 1856 используются для хранения 64 спрайтов (29 разрядов на спрайт), а остальные 32 байта используются специальным образом, для выборки 8 текущих спрайтов, которые будут показаны на текущей строке. Эта область OAM обычно называется "temporary OAM" или OAM2.

Расположение спрайтовой памяти на кристалле и комбинированное изображение топологии ячейки памяти:

<img src="/BreakingNESWiki/imgstore/ppu_oam_preview.jpg" width="280px"> <img src="/BreakingNESWiki/imgstore/ppu_oam_closeup.jpg" width="400px">

Схемы OAM:
- Массив ячеек памяти (2112 ячейка)
- Декодер колонки
- Декодер ряда
- OAM Buffer (OB)
- Схема контроля OAM Buffer

## Организация OAM

TBD: Тут нужно написать как уложены ячейки и каким образом адресуется память.

## Ячейка памяти

![oam_cell](/BreakingNESWiki/imgstore/oam_cell.jpg)

Ячейка представляет собой типовую 4T-ячейку, но с одним исключением - транзисторы ячейки, на которых хранится значение, не подключены к Vdd, 
поэтому значение на ячейке постоянно деградирует, т.к. без подтяжки хранится по сути на затворах транзисторов.

Эффект деградации памяти OAM назвается "OAM Corruption" и он широко известен. Для борьбы с этим эффектом программы для NES
содержат кэш OAM в обычной памяти процессора и каждый VBlank копируют этот кэш в OAM с помощью спрайтовой DMA APU.

TBD: Рассчитать или измерить тайминги деградации ячеек.

## Декодер колонки

![oam_cas](/BreakingNESWiki/imgstore/oam_cas.jpg)

Схема представляет собой одноединичный декодер (1-из-n).

Выходы COL для разрядов OAM Buffer 0, 1, 5-7:

![oam_col_outputs1](/BreakingNESWiki/imgstore/oam_col_outputs1.jpg)

Выходы COL для разрядов OAM Buffer 2-4:

![oam_col_outputs2](/BreakingNESWiki/imgstore/oam_col_outputs2.jpg)

## Декодер ряда

![oam_ras](/BreakingNESWiki/imgstore/oam_ras.jpg)

Схема представляет собой одноединичный декодер (1-из-n).

## OAM Buffer (OB)

OAM Buffer используется как перевалочный пункт для хранения байта который нужно записать в OAM или байта, который был прочитан из OAM для потребителей.

Схема состоит из 8 идентичных схем для каждого разряда:

![oam_buffer_bit](/BreakingNESWiki/imgstore/oam_buffer_bit.jpg)

(На картинке представлена схема для хранения разряда OB0).

Данные с OB проходят через небольшую схему Readback:

![oam_buffer_readback](/BreakingNESWiki/imgstore/oam_buffer_readback.jpg)

## Схема управления OAM Buffer

Схема используется для задания режимов работы OB и управлением передачи значений между ним и OAM.

![oam_buffer_control](/BreakingNESWiki/imgstore/oam_buffer_control.jpg)
