# Pixel Clock (PCLK)

Pixel clock (сокращенно PCLK) используется всеми узлами PPU (кроме генератора фаз видеосигнала).

Причем симметрично используются как низкий уровень (`/PCLK`), так и высокий (`PCLK`). Такой подход внутренней реализации циклов был широко распространен в эру микросхем NMOS. Поэтому при анализе схем PPU следует думать не о PCLK как тактовом сигнале, а о двух "состояниях" (стейтах) - PCLK=0 и PCLK=1.

Условно `/PCLK` можно назвать "подготовка", а `PCLK` - "вывод пикселя".

Иногда ещё интуитивно /PCLK называют "левой половиной пикселя", а PCLK - "правой половиной пикселя".

`PCLK` получается путем замедления (деления) входного тактового сигнала `CLK` (21.48 MHz) в 4 раза.

Для этого используется делитель на статических защелках:

<img src="/BreakingNESWiki/imgstore/ppu/pclk.jpg" width="400px">

Чуть ниже делителя находится расщепитель одиночной фазы. Это каноничная схема, основанная на одном FF, которая из одной фазы (PCLK) делает две (/PCLK + PCLK).

На выходе делителя находится много push/pull усилительных каскадов, поскольку сигнал `PCLK` должен быть достаточно мощным, т.к. разводится практически по всей микросхеме. Для этого (чуть правее на кристалле) находится гребенка ещё более мощных push/pull инверторов:

![pclk_amp](/BreakingNESWiki/imgstore/ppu/pclk_amp.jpg)

Входной тактовый сигнал `CLK` используется исключительно в [фазогенераторе](video_out.md) видеотракта PPU.

Тайминги:

|PPU|CLK|Длительность цикла CLK|PCLK|Длительность цикла PCLK|
|---|---|---|---|---|
|NTSC|21477272 Hz|~0,046 µs|5369318 Hz|~0,186 µs|
|PAL|26601712 Hz|~0,037 µs|5320342.4 Hz|~0,187 µs|

## Состояние при включении питания

Сложно сказать какие значения находятся на защелках (затворах). Если полагать, что после включения питания `CLK` равен 0, а `z` (терминами HDL означает "отсоединено") на затворе это то же самое, что 0 (затвор закрыт), то значения защелок примут следующие значения: [ 0, 1, 0, 1 ]

(Первая защелка находится рядом с сигналом `RES`)

Но вообще правильнее считать, что значение защелок не определено (`x`)

## Состояние при сбросе (RES)

![pclk_reset](/BreakingNESWiki/imgstore/ppu/pclk_reset.png)

## Логическая схема

![pclk_2C02G](/BreakingNESWiki/imgstore/ppu/pclk_2C02G.jpg)

## PCLK Distribution

Ниже приведены отличительные особенности разводки PCLK.

![2C02G_PCLK_Distrib_sm](/BreakingNESWiki/imgstore/ppu/2C02G_PCLK_Distrib_sm.png)

|Особенность|Описание|
|---|---|
|1|CLK Distribution|
|2|Делитель PCLK|
|3|Расщепитель одиночной фазы. Выдает две симметричные фазы: /PCLK и PCLK|
|4|Инвертирующий супербуфер для /PCLK и PCLK|
|5|Местные подтяжки PCLK|
|6|"Другой" /PCLK (`/PCLK2`), используемый в логике сравнения спрайтов|
|7|OB Pass. Транзисторы для формирования входных защёлок компаратора спрайтов|
|8|THO Pass. Транзисторы для формирования входных защёлок входов THOx для мультиплексора|
|9|OAM PCLK Precharge|
|10|CRAM PCLK Precharge|
|11|PCLK Anti-jitter. Транзисторы используются для ускорения "рассасывания" сигнала|
|12|Выход /PCLK для терминалов EXT|

Изображение в полном размере: https://github.com/emu-russia/breaks/blob/master/Docs/PPU/2C02G_PCLK_Distrib.jpg
