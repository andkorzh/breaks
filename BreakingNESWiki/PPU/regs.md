# Регистры

Данный раздел содержит описание только управляющих регистров PPU ($2000/$2001) и вспомогательной логики, которая относится к CPU интерфейсу.

Остальные регистры равномерно "размазаны" по всем частям PPU и входят в состав управляющей логики соответствующих узлов и рассматриваются отдельно.

Интерфейс CPU:

|Название|Направление|Описание|
|---|---|---|
|R/W	|в PPU	|Read-notWrite. Используется для чтения/записи регистров PPU. Если R/W = 1, то производится чтение, иначе запись. Запомнить контакт легко : "Читаем(1), не пишем".|
|D0-D7	|двунаправленная	|Шина данных для передачи значений регистров. Когда /DBE = 1 шина отсоединена (Z)|
|RS0-RS2	|в PPU	|Register Select. Задается номер регистра PPU (0-7)|
|/DBE	|в PPU	|Data Bus Enable. Если /DBE = 0, то шина D0-D7 используется для обмена значений с регистрами PPU, иначе шина отсоединена.|

## R/W Декодер

Схема находится выше спрайтовой логики.

Декодер предназначен для получения двух комплементарных управляющих линий `/RD` и `/WR` из входного контакта интерфейса CPU R/W.

![ppu_rw_decoder](/BreakingNESWiki/imgstore/ppu_rw_decoder.jpg)

## Выбор регистра

Схема находтся правее H/V счетчиков.

Схема занимается выбором регистровой операции. На вход поступает:
- RS0-2 (входные контакты интерфейса CPU): Индекс регистра PPU (0-7)
- /RD, /WR (получаются R/W декодером): Тип операции (чтение или запись)

На выходе схемы получаются много контрольных линий, которые активируют операцию чтения или записи для соотвтетствующего регистра (напр. `/R7` - означает "Прочитать регистр $2007")

![ppu_reg_select](/BreakingNESWiki/imgstore/ppu_reg_select.jpg)

## Специальная обработка для регистров $2005/$2006

Как известно, 2 последовательные записи в регистр $2005 или $2006 на самом деле записывают значение сначала в младшую, а затем в старшую половинку соответствующего внутреннего 16-разрядного регистра (FV/FH).

Для слежения за историей записи в $2005/$2006 применяется схема с защелкой.

Защелка запоминает только порядок обращения (1 или 2), но не номер регистра. Поэтому если первый раз записать в регистр $2005, то следующая за этим запись в регистр $2006 будет рассматриваться как вторая запись.

Сбрасывается защелка сигналом `RC` или чтением регистра $2002.

## Управляющие регистры

Схема находятся ниже спрайтовой логики над мультиплексором (MUX).

<img src="/BreakingNESWiki/imgstore/ppu_control_regs.jpg" width="1000px">

## Специальное примечание

Нужно понимать, что обращение к регистрам PPU никак не связано с PCLK. Поэтому программист может вмешиваться в процесс рендеринга PPU в любое время.
Технически это делать можно, но не рекомендуется, т.к. может приводить к разным side-эффектам. Информация когда можно обращаться к регистрам без последствий есть в любом PPU Reference Manual.

Но с другой стороны это может использоваться (и применяется в играх на самом деле) для получения интересных визуальных эффектов.

## Симуляция

TBD.
