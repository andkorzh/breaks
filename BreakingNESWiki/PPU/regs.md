# Регистры

![ppu_locator_regs](/BreakingNESWiki/imgstore/ppu/ppu_locator_regs.jpg)

Данный раздел содержит описание только управляющих регистров PPU ($2000/$2001) и вспомогательной логики, которая относится к CPU интерфейсу.

Остальные регистры равномерно "размазаны" по всем частям PPU и входят в состав управляющей логики соответствующих узлов и рассматриваются отдельно.

Примечание: Здесь и далее мы приводим привычное для NES/Famicom обозначение регистров, начинающееся с адреса $2000. Но этот маппинг производится вне PPU. Внутри PPU регистры индексируются как $0-$7.

Интерфейс CPU:

|Название|Направление|Описание|
|---|---|---|
|R/W|input|Read-notWrite. Используется для чтения/записи регистров PPU. Если R/W = 1, то производится чтение, иначе запись. Запомнить контакт легко: "Читаем(1), не пишем".|
|D0-D7|inOut|Шина данных для передачи значений регистров. Когда /DBE = 1 шина отсоединена (Z)|
|RS0-RS2|input|Register Select. Задает номер регистра PPU (0-7)|
|/DBE|input|Data Bus Enable. Если /DBE = 0, то шина D0-D7 используется для обмена значений с регистрами PPU, иначе шина отсоединена.|

## R/W Декодер

Схема находится выше спрайтовой логики.

Декодер предназначен для получения двух комплементарных управляющих сигналов `/RD` и `/WR` из входного контакта интерфейса CPU R/W, которые используются для контактов внешней шины D0-D7. Сигналы /RD и /WR комплементарны когда /DBE = 0. Если /DBE = 1 (CPU интерфейс отключен) оба сигнала равны `1` (ни чтение, ни запись).

|![rw_decoder](/BreakingNESWiki/imgstore/ppu/rw_decoder.jpg)|![rw_decoder_logic](/BreakingNESWiki/imgstore/ppu/rw_decoder_logic.jpg)|
|---|---|

## Read/Write Enablers

Рядом со схемами, где используются регистры пристутвуют небольшие схемы, которые мы называем Read/Write Enablers.

Пример такой схемы, R4 Enabler (находится левее RW декодера):

|![r4_enabler_tran](/BreakingNESWiki/imgstore/ppu/r4_enabler_tran.jpg)|![rw_enabler_logic](/BreakingNESWiki/imgstore/ppu/rw_enabler_logic.jpg)|
|---|---|

## Выбор регистра

Схема находится правее H/V счётчиков.

Схема занимается выбором регистровой операции. На вход поступает:
- RS0-2 (входные контакты интерфейса CPU): Индекс регистра PPU (0-7)
- R/W: Тип операции (чтение или запись)

На выходе схемы получаются много контрольных линий, которые активируют операцию чтения или записи для соответствующего регистра (напр. `/R7` - означает "Прочитать регистр $2007")

|![reg_select](/BreakingNESWiki/imgstore/ppu/reg_select.jpg)|![reg_select_logic](/BreakingNESWiki/imgstore/ppu/reg_select_logic.jpg)|
|---|---|

## Специальная обработка для регистров $2005/$2006

Как известно, 2 последовательные записи в регистр $2005 или $2006 на самом деле записывают значение в [спаренные регистры $2005/$2006](scroll_regs.md) (FV/FH/TV/TH).

Для слежения за историей записи в $2005/$2006 применяется схема с защелкой.

Защелка запоминает только порядок обращения (1 или 2), но не номер регистра. Поэтому если первый раз записать в регистр $2005, то следующая за этим запись в регистр $2006 будет рассматриваться как вторая запись.

Сбрасывается защелка сигналом `RC` или чтением регистра $2002.

![scc_first_second_logic](/BreakingNESWiki/imgstore/ppu/scc_first_second_logic.jpg)

## Управляющие регистры

Схема находятся ниже спрайтовой логики над мультиплексором (MUX).

<img src="/BreakingNESWiki/imgstore/ppu/control_regs.jpg" width="1000px">

Схема одного разряда:

![reg_ff_logic](/BreakingNESWiki/imgstore/ppu/reg_ff_logic.jpg)

Логическая схема:

|PPU CTRL0 ($2000)|PPU CTRL1 ($2001)|
|---|---|
|![ctrl0](/BreakingNESWiki/imgstore/ppu/ctrl0.jpg)|![ctrl1](/BreakingNESWiki/imgstore/ppu/ctrl1.jpg)|

### Специальное примечание

Нужно понимать, что обращение к регистрам PPU никак не связано с PCLK. Поэтому программист может вмешиваться в процесс рендеринга PPU в любое время.
Технически это делать можно, но не рекомендуется, т.к. может приводить к разным side-эффектам. Информация когда можно обращаться к регистрам без последствий есть в любом PPU Reference Manual.

Но с другой стороны это может использоваться (и применяется в играх на самом деле) для получения интересных визуальных эффектов.

## Clipping

Ниже контрольных регистров находится небольшая схема, для получения контрольных сигналов `/CLPB` и `CLPO`:

|![clp_tran](/BreakingNESWiki/imgstore/ppu/clp_tran.jpg)|
|---|
|![clp_logic](/BreakingNESWiki/imgstore/ppu/clp_logic.jpg)|

Она по идее относится больше к управляющей логике, но топологически находится совсем в другом месте, поэтому рассматривается в этом разделе.

В этом месте можно рассказать про зоопарк сигналов, связанных с Clipping.

|Сигнал|Откуда|Куда|Описание|
|---|---|---|---|
|/BGCLIP|Regs $2001\[1\]|FSM|0: Выполнить отсечение левых 8 пикселей в строке для бэкграунда|
|/OBCLIP|Regs $2001\[2\]|FSM|0: Выполнить отсечение левых 8 пикселей в строке для спрайтов|
|CLIP_B|FSM|Regs|1: Активен если включено отсечение 8 левых пикселей бэкграунда и настал нужный момент (счётчик H принял нужное значение)|
|CLIP_O|FSM|Regs|1: Активен если включено отсечение 8 левых пикселей спрайтов и настал нужный момент (счётчик H принял нужное значение)|
|/CLPB|Regs|BGCOL|0: Отсечение бэкграунда. Финальный сигнал для схемы BGCOL|
|CLPO|Regs|FIFO|1: Отсечение спрайтов. Финальный сигнал для схемы OAM FIFO|
