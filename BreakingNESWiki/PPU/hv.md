# H/V Счётчики

H/V-счетчики считают количество пикселей в строке и количество строк, соответственно. H тикает от 0 до 340 (включая), V тикает от 0 до 261 (включая). Итого видимая часть экрана представляет собой 262 строки по 341 пикселя каждая.

Технически счетчики состоят из 9 разрядов, поэтому могут считать от 0 до 0x1FF, но они никогда не считают полностью и ограничиваются максимальными значениями H и V. Для этого схема H/V FSM периодически сбрасывает их.

## Стадия счетчика

Рассмотрим работу одной стадии (разряда) счетчика на примере V-Counter.

![hv_stage](/BreakingNESWiki/imgstore/hv_stage.jpg)

![hv_stage2](/BreakingNESWiki/imgstore/hv_stage2.jpg)

![hv_stage2_annotated](/BreakingNESWiki/imgstore/hv_stage2_annotated.jpg)

- `/carry_in`: входной перенос в инверсной логике
- `/carry_out`: выходной перенос в инверсной логике
- `out`: выход одного разряда счетчика, в прямой логике
- `VC` (или `HC` у H-Counter): сигнал очистки всего счетчика. Данный способ очистки используется для управления очисткой счетчиков со стороны схемы H/V FSM.
- `RES`: сигнал общего сброса. Это глобальный сигнал сброса всех последовательностных схем PPU.
- `PCLK`: Pixel Clock

На изображении выделены транзисторы, которые формируют логические элементы.

Схема не очень сложная, за исключением необычной организации FF на базе двух 2-nor и двух мультиплексоров, которые формируют петлю FF.

Красивая схема из Logisim:

![hv_stage_logisim](/BreakingNESWiki/imgstore/hv_stage_logisim.jpg)

## Устройство H/V счетчиков

TODO: переделать, немного упростить

Так как H-counter считает все время, то вход самого первого каскада заведен на Vdd.
Вход V-counterа регулируется H-декодером. когда H=340, то вход V-Counter `/V_IN` устанавливается в 0 (`/carry_in` = 0), что дает возможность увеличить его значение на 1.
Выходной перенос каждого предыдущего бита заведен на входной перенос следующего, для формирования инвертированной carry-chain.

Весь H-counter (транзисторная и логическая схема):

<img src="/BreakingNESWiki/imgstore/H_trans.jpg" width="500px"> <img src="/BreakingNESWiki/imgstore/H.jpg" width="500px">

- Переносы с 0 по 4 суммируются через NOR и подаются на вход 5.
- Вход 0 заведен на Vdd (счетчик всегда считает)

## Зачем нужна логика переноса

Счетчики включают в свой состав такой небольшой кусочек:

![CARRYH](/BreakingNESWiki/imgstore/CARRYH.jpg)

Зачем он нужен? Скорее всего, чтобы уменьшить propagation delay цепочки переносов.

## Симуляция
