# Обзор PPU

PPU (Picture Processing Unit) - специализированная микросхема для генерации видеосигнала.

Примерная картинка, которую может выдать PPU:

<img src="/BreakingNESWiki/imgstore/ppu/battletoads.jpg" width="400px">

Ревизии микросхем PPU (предварительная сводная таблица, информация будет уточняться):

|Ревизия|Описание|
|---|---|
|2C02G|Применялась в Famicom и американской версии NES. Генерирует NTSC сигнал.|
|2C02H| |
|2C03|RGB-версии для аркадных автоматов на базе NES (PlayChoice-10, Vs. System)|
|2C03B| |
|2C03C| |
|2C04-0001| |
|2C04-0002| |
|2C04-0003| |
|2C04-0004| |
|2C05-01| |
|2C05-02| |
|2C05-03| |
|2C05-04| |
|2C05-99|Famicom Titler|
|2C07-0|PAL-версия PPU для европейских NES|

Возможно существуют (но их никто не видел):
- 2C01: Отладочная версия NTSC PPU (?)
- 2C06: Отладочная версия PAL PPU (?)

## Архитектура

Основные компоненты PPU:

![PPU_preview](/BreakingNESWiki/imgstore/PPU_preview.jpg)

- VIDEO OUT: содержит схему формирования NTSC-сигнала и ЦАП, для преобразования его в аналоговую форму. То есть по сути PPU является полу-аналоговой микросхемой, так как с контакта VOUT выходит уже готовый к употреблению аналоговый сигнал (композитное видео).
- Рядом со схемой VOUT находится блок управления, который на базе двух счётчиков H и V формирует пачку управляющих сигналов, для остальных компонентов.
- Палитра. Содержит 16 цветов бэкграунда и 16 цветов спрайтов. По индексу в палитре в COLOR BUFFER загружается цвет пикселя, который будет выведен на экран.
- Мультиплексор (MUX). Выбирает что будет выводиться на экран: точка бэкграунда или точка спрайта, на основе их приоритетов. Также есть возможность подмешать цвет с внешних контактов EXT.
- Регистры. Всего адресное пространство PPU позволяет адресовать 8 внутренних регистров. Разработчики очень хитро подошли к вопросу организации регистров и запись по одному адресу может делать 2 разных действия.
- Спрайтовая память (OAM). Содержит данные 64 спрайтов, а также дополнительное место для хранения выбранных 8 текущих спрайтов.
- Спрайтовая логика. На базе V-счётчика выбирает 8 спрайтов текущей строки, которые в процессе сравнения помещаются в дополнительную память OAM.
- Спрайтовая FIFO (OAM FIFO). Содержит схему, которая активирует вывод 8 выбранных спрайтов в нужный момент, а также схему контроля их приоритета.
- Схема управления адресной шиной. Управляет адресацией VRAM.
- Схемы выборки данных (DATA READER). Схема для выборки исходных данных из VRAM: тайлов и атрибутов. Включает в себя генератор адреса PAR и схему получения цвета бэкграунда.

## Шины PPU

PPU содержит следующие внутренние шины данных:

|Название шины|Аббревиатура|Мастер шины|Пользователи|
|---|---|---|---|
|CPU Data Bus|DB|PPU Regs|PatGen, OAM Ctr, OAM Buffer, Ctr Regs, Color Buffer, Read Buffer, Strike Test, Interrupt Ctr|
|PPU Data Bus|PD|NT RAM, CHR ROM, $2007|PatGen, BGCOL, H. INV|
|Object Bus|OB|OAM Buffer|PatGen, Obj FIFO, OAM Eval|

:warning: Для корректной симуляции и реализации PPU на Verilog имеет большое значение ёмкость шины DB. Значение помещенное на шину со стороны процессора, во время записи в регистры PPU может быть использовано внутренними схемами PPU для которых оно предназначается даже после того как интерфейс CPU завершил свою работу (/DBE = 1). Таким образом значение на шине DB ещё "болтается" некоторое время, а потом используется схемами PPU. В особенности это касается регистров $2003 и $2007. Рекомендуется использовать Transparent Latch или Bus Keeper, если вы собираетесь реализовывать схемы PPU на HDL.

Шина PD (PPU Data) в меньшей степени подвержена приколам с плавающими значениями, так как она совмещена (мультиплексирована) с шиной PA (PPU Address).

## Примечание по транзисторным схемам

Транзисторные схемы каждого компонента напилены на составные части, чтобы не занимали много места.

Чтобы вы не заблудились, каждый раздел включает в начале специальный "локатор", где отмечено приблизительное расположение изучаемого компонента.

Пример локатора:

![ppu_locator_rails_left](/BreakingNESWiki/imgstore/ppu/ppu_locator_rails_left.jpg)

## Примечание по логическим схемам

Логические схемы в основном сделаны в программе Logisim. Для обозначения DLatch применяется такой элемент:

|DLatch (транзисторная схема)|DLatch (логический эквивалент)|
|---|---|
|![dlatch_tran](/BreakingNESWiki/imgstore/dlatch_tran.jpg)|![dlatch_logic](/BreakingNESWiki/imgstore/dlatch_logic.jpg)|

Для удобства логический вариант DLatch имеет два выхода (`out` и `/out`), так как текущее значение DLatch (out) нередко используется как вход для операции NOR.
