# Мультиплексор

Мультиплексор PPU - это маленькая злая схема, которая занимается выбором цвета пикселя, который затем подается на вход палитровой памяти как индекс, для выбора финального цвета для [фазогенератора](video_out.md).

Как обычно под "цветом" и "пикселем" понимаются абстрактные понятия: цвет - это комбинация цветности/яркости для фазогенератора, а пиксель - это часть видимого видеосигнала. 

Входы:
- Цвет бэкраунда (4 бит)
- Цвет спрайта (4 бит)
- Цвет с внешних контактов (EXT In) (4 бит)
- Прямой цвет с TH (5 бит)

Выходы:
- Индекс цвета для палитры (5 бит)
- Цвет для внешних контактов (EXT Out) (4 бит)

## Транзисторная схема

![ppu_mux](/BreakingNESWiki/imgstore/ppu_mux.jpg)

Как видно, схема выглядит весьма запутано на первый взгляд. Это по причине того, что мультиплесоры (как элементы схемы) очень сложно распознать из NMOS транзисторов.

## Схема Logisim

![ppu_mux_logisim](/BreakingNESWiki/imgstore/ppu_mux_logisim.jpg)

(Кусок схемы для проверки Sprite 0 Hit не показана и отмечена как "to strike test").

Сигналы:

|Сигнал|Назначение|
|---|---|
|BGC0-3|Цвет бэкграунда|
|ZCOL0-3|Цвет спрайта|
|EXT0-3 IN|Входной цвет с контактов EXT|
|THO0-4|Входной цвет с TH|
|TH/MUX|Определяет приоритет прямого цвета с TH над всеми остальными цветами|
|ZPRIO|Определяет приоритет цвета спрайта над цветом бэкграунда|
|EXT0-3 OUT|Выходной цвет для контактов EXT|
|PAL0-4|Выходной цвет для индексирования палитры|

Схема представляет из себя каскад мультиплексоров, между которыми находятся D-Latch:
- В первый стейт выбирается цвет бэкграунда/спрайта. Какой цвет выбрать определяет схема по разрядам BGC0-1, ZCOL0-1 и приоритету спрайтов ZPRIO. Результатом работы этой схемы является внутренний управляющий сигнал `OCOL`, который подается на мультиплексоры разрядов;
- Во второй стейт делается выбор между предыдущим результатом и внешним цветом с контактов EXT;
- В третий стейт делается выбор между результатом второго стейта и прямым цветом с счетчика TH (Tile Horizontal). Приоритет прямого цвета задается контрольным сигналом `TH/MUX`  (подробнее об этом будет дополнено, после рассмотрения схема [Data Reader](dataread.md), где находится TH).

"Прямой цвет" выглядит интригуюеще, так как это звучит как возможность вывода непосредственных растровых изображений, минуя особенности тайловой/спрайтовой графики PPU. Этот вопрос требует дополнительного исследования.

## Sprite 0 Hit

Sprite 0 Hit - это алиенская особенность работы PPU.

Эта фича предназначена для определения момента, когда спрайт #0 "пересекся" с бэкграундом.

Данное событие хранится как разряд регистра $2002[6].

Фича может быть использовать программистом для определения момента рендеринга определенной точки экрана:
- Спрайт #0 устанавливается в определенную позицию
- Производится поллинг регистра $2002[6]
- Программа выполняет дополнительные действия при обнаружении Sprite 0 Hit.

Обычно это используется для создания эффектов "Split Screen".

Схема Sprite 0 Hit:

![spr0hit](/BreakingNESWiki/imgstore/spr0hit.jpg)

Контрольный выход `STRIKE` равен 1 только когда BGC0=1 или BGC=1, при этом все остальные входы равны 0.

Контрольный сигнал `SPR0HIT` приходит со схемы контроля приоритетов спрайтов (см. [OAM FIFO](fifo.md)), а контрольный сигнал `LOL` (точный смысл его пока не известен) со [схемы сравнения спрайтов](sprite_eval.md).
