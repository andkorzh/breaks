# Мультиплексор

![ppu_locator_mux](/BreakingNESWiki/imgstore/ppu/ppu_locator_mux.jpg)

Мультиплексор PPU - это маленькая злая схема, которая занимается выбором цвета пикселя, который затем подается на вход палитровой памяти как индекс, для выбора финального цвета для [фазогенератора](video_out.md).

Как обычно под "цветом" и "пикселем" понимаются абстрактные понятия: цвет - это комбинация цветности/яркости для фазогенератора, а пиксель - это часть видимого видеосигнала. 

Входы:
- Цвет бэкраунда (4 бит)
- Цвет спрайта (4 бит)
- Цвет с внешних контактов (`EXT In`) (4 бит)
- Прямой цвет с счётчика PAR TH (5 бит)

Выходы:
- Индекс цвета для палитры (5 бит)
- Цвет для внешних контактов (`/EXT Out`) (4 бит)

## Транзисторная схема

![mux](/BreakingNESWiki/imgstore/ppu/mux.jpg)

Как видно, схема выглядит весьма запутано на первый взгляд. Это по причине того, что мультиплексоры (как элементы схемы) очень сложно распознать из NMOS транзисторов.

Сигналы `THOx'` получаются из защелок THO следующим образом:

![tho_latches_tran](/BreakingNESWiki/imgstore/ppu/tho_latches_tran.jpg)

(Находится в правом нижнем углу MUX).

## Логическая схема

![mux_logic](/BreakingNESWiki/imgstore/ppu/mux_logic.jpg)

Схема управления:

![mux_control_logic](/BreakingNESWiki/imgstore/ppu/mux_control_logic.jpg)

Сигналы:

|Сигнал|Назначение|
|---|---|
|BGC0-3|Цвет бэкграунда|
|/ZCOL0, /ZCOL1, ZCOL2, ZCOL3|Цвет спрайта|
|EXT0-3 IN|Входной цвет с контактов EXT|
|THO0-4|Входной цвет с счётчика TH|
|TH/MUX|Определяет приоритет прямого цвета с TH над всеми остальными цветами|
|/ZPRIO|Определяет приоритет цвета спрайта над цветом бэкграунда (0: спрайты сверху)|
|/EXT0-3 OUT|Выходной цвет для контактов EXT|
|PAL0-4|Выходной цвет для индексирования палитры|

Схема представляет из себя каскад мультиплексоров, между которыми находятся D-Latch:
- В первый стейт выбирается цвет бэкграунда/спрайта. Какой цвет выбрать определяет схема по разрядам BGC0-1, /ZCOL0-1 и приоритету спрайтов /ZPRIO. Результатом работы этой схемы является внутренний управляющий сигнал `OCOL`, который подается на мультиплексоры разрядов;
- Во второй стейт делается выбор между предыдущим результатом и внешним цветом с контактов EXT;
- В третий стейт делается выбор между результатом второго стейта и прямым цветом с счётчика TH (Tile Horizontal). Приоритет прямого цвета задается контрольным сигналом `TH/MUX`.

"Прямой цвет" - это специальная обработка для доступа к памяти палитры со стороны CPU интерфейса. Так как память палитры замаплена на адресное пространство PPU - при доступе к палитре её индекс временно хранится на счётчике PAR TH (5 бит). При этом [контроллер VRAM](vram_ctrl.md) устанавливает сигнал TH/MUX, который говорит о том, что на счётчике TH находится выбранный индекс палитры (цвет). Выходы с счётчика TH (THO0-4) поступают на мультиплексор, который выбирает нужный индекс палитры.

## Sprite 0 Hit

Sprite 0 Hit - это алиенская особенность работы PPU.

Эта фича предназначена для определения момента, когда спрайт #0 "пересекся" с бэкграундом.

Данное событие хранится как разряд регистра $2002\[6\].

Фича может быть использовать программистом для определения момента рендеринга определенной точки экрана:
- Спрайт #0 устанавливается в определенную позицию
- Производится поллинг разряда регистра $2002\[6\]
- Программа выполняет дополнительные действия при обнаружении Sprite 0 Hit.

Обычно это используется для создания эффектов "Split Screen".

Схема Sprite 0 Hit:

![spr0_hit_logic](/BreakingNESWiki/imgstore/ppu/spr0_hit_logic.jpg)

Контрольный выход `STRIKE` равен 1 только когда BGC0=1 или BGC1=1, при этом все остальные входы равны 0.

Контрольный сигнал `/SPR0HIT` приходит со схемы контроля приоритетов спрайтов (см. [OAM FIFO](fifo.md)), а контрольный сигнал `/SPR0_EV` со [схемы сравнения спрайтов](sprite_eval.md).

## Трюки с мультиплексором

Зная особенности работы мультиплексора можно эксплуатировать их для получения различных визуальных эффектов.

### Работа с прямым цветом

Этот трюк применим только с отключенным рендерингом PPU (OAM/Background = OFF).

В этом режиме PPU получает индекс палитры с счётчика TH, как было описано выше, поэтому делая запись в адресное пространство PPU по адресам $3Fxx (где xx = 0x00 ... 0x1F) можно обманным путем заставлять PPU показывать цвет палитры с указанным индексом.
(На самом деле даже не обязательно делать чтение/запись байта памяти палитры, а достаточно лишь установить PPU адрес с помощью регистра $2006, чтобы его младшая часть сохранилась в счётчике TH).

Данная техника демонстрируется в `Full palette demo` (Blargg): https://wiki.nesdev.org/w/index.php/Full_palette_demo

Там же указано, что скорость работы CPU NES не достаточна для имитации полноценной растровой графики (1 цикл CPU соответствует 3 "пикселям" PPU)

### Эксплуатация контактов EXT

Значение с контактов EXT можно использовать как ещё один источник цвета. Но так как эти контакты обычно подсоединены к GND с них можно получить только черный цвет, который можно использовать для закрашивания изображения произвольными паттернами.

Для этого нужно программным путем переводить PPU в режим Slave ($2000\[6\] = 0) в момент когда значения счётчиков H/V PPU находятся в требуемом месте экрана.

Данная техника пока не подтверждена экспериментально и существует только в виде гипотезы.
