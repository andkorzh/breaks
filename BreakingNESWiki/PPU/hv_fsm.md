# Управляющая логика H/V

## H/V Декодер

H/V-декодер выбирает нужные пиксели и строки для H/V-логики.

### Декодер H NTSC

TBD.

### Декодер V NTSC

TBD.

### Декодер H PAL

![pal_h](/BreakingNESWiki/imgstore/pal_h.png)

```
0 01010 101 01000 01001 00000
1 10001 000 10000 10010 11111
1 11101 101 10000 00011 11111
0 00000 010 00000 00000 00000
1 10100 101 10000 00011 11010
0 01001 010 00000 10000 00101
1 11101 000 00000 10011 10101
0 00000 110 00000 00000 01010
0 11100 000 00000 10011 01100
1 00001 110 00000 00000 10011
1 11101 000 00000 00011 10111
0 00000 110 00000 00000 01000
0 11001 000 00100 00110 00110
1 00000 110 00011 00001 11001
1 11000 000 00101 00011 10101
0 00001 110 00010 00100 01010
0 10000 000 00000 00011 01011
1 01001 110 00000 00000 10100
0 00010 000 01000 00000 00000
0 01001 111 11100 11000 00000
```

|Выход HPLA|Номера пикселей\* строки|BLNK|VB|Смысловое значение/с чем связан|
|---|---|---|---|---|
|0|277| | |FPorch FF|
|1|256| | |FPorch FF|
|2|65| |yes|S/EV|
|3|0-7, 256-263(?)| | |CLIP_O / CLIP_B|
|4|0-255|yes| |CLIP_O / CLIP_B|
|5|339| |yes|0/HPOS|
|6|63| |yes|EVAL|
|7|255| |yes|E/EV|
|8|0-63| |yes|I/OAM2|
|9|256-319| |yes|PAR/O|
|10|0-255|yes|yes|/VIS|
|11|Каждый 0..1| |yes|F/NT|
|12|Каждый 6..7| | |F/TB|
|13|Каждый 4..5| | |F/TA|
|14|320-335| |yes|/FO|
|15|0-255| |yes|F/AT|
|16|Каждый 2..3| | |F/AT|
|17|256| | |BPorch FF|
|18|4| | |BPorch FF|
|19|277| | |HBlank FF|
|20|302| | |HBlank FF|
|21|321| | |BUSRT/VSYNC FF|
|22|306| | |BUSRT/VSYNC FF|
|23|340| | |HCounter clear / VCounter step|

\* - под "пикселем" понимается временной интервал, который базируется на PCLK. Не все "пиксели" отображаются как изображение, часть определяют различные управляющие порции сигнала, типа HSync, Color Burst и проч.

### Декодер V PAL

![pal_v](/BreakingNESWiki/imgstore/pal_v.png)

```
001 00100 00
110 00001 11
111 00101 11
000 11010 00
111 00101 11
000 11010 00
111 00100 01
000 11011 10
011 00100 01
100 11011 10
101 11111 10
010 00000 01
101 11110 01
010 00001 10
111 11110 01
000 00001 10
100 10110 00
011 01001 11
```

|Выход VPLA|Номер строки|Смысловое значение|
|---|---|---|
|0|272| |
|1|269| |
|2|1| |
|3|240| |
|4|241| |
|5|0| |
|6|240| |
|7|311| |
|8|311| |
|9|265| |

## H/V Конечный автомат

Логика H/V представляет собой конечный автомат (FSM), который управляет всеми остальными узлами PPU. Схематически это просто набор защелок, по типу "эта защелка активна от 64го до 128го пикселя", значит соответствующая контрольная линия идущая от этой защелки тоже активна.

Предварительные результаты получения логических схема H/V логики. Нужно будет потом ещё проверить "инверсность" названий (косая черточка перед названием линии).

"Горизонтальная" логика, отвечает за генерацию контрольных линий в зависимости от горизонтального положения луча (H):

<img src="/BreakingNESWiki/imgstore/7fc48a229053d2cf091195ec01a345ce.jpg" width="1000px">

### Очистка H/V счетчиков

TBD.

### Логика ODD/EVEN

![odd_1](/BreakingNESWiki/imgstore/5c4d95b2bf506ef6b183cf8bb46e9433.jpg) ![odd_2](/BreakingNESWiki/imgstore/e4220e0351932b00026250fc2f3c858a.jpg) ![odd_3](/BreakingNESWiki/imgstore/e7d09137ee29ae53340df1cb2285585f.jpg)

Логика ODD/EVEN состоит из двух замкнутых друг на друга псевдозащелок, управляемых двумя мультиплексорами. Получается такая очень хитрая "макро"-защелка.

TODO: Схему нужно проанализровать ещё раз, т.к. что это за фигня такая - "макро-защелка".. К тому же схема для PAL PPU отличается от NTSC версии.
