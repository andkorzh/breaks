# OAM FIFO

Расположение на чипе:

![OAM_FIFO_preview](/BreakingNESWiki/imgstore/OAM_FIFO_preview.jpg)

Спрайтовый FIFO используется для временного хранения до 8 спрайтов, которые попали в текущую строку.

Хранится на самом деле не весь спрайт, а только одна его строка (8 пикселей), бит приоритета и 2 бита общего цвета.

Примечание по поводу термина "FIFO": на самом деле в явном виде этот компонент так нигде не называется, но авторы посчитали использование этого термина удобным в перспективе очередности вывода спрайтов на экран.

## Как это работает

FIFO состоит из 3х частей: обратного счетчика пикселей, атрибутов спрайта и спаренного сдвигового регистра.

Обратный счетчик загружается горизонтальным смещением спрайта и тикает вниз до 0, одновременно с рендерингом пикселей. Как только счетчик достигает 0, это означает что можно начинать выводить пиксели спрайта.

В атрибутах хранится 2 бита общей цветности спрайта и 1 бит приоритета над бэкграундом. Эти значения используются для всей выводимой строки.

Сдвиговый регистр используется для "выталкивания" очередной точки спрайта. А спаренный он потому что для точки используется 2 бита цветности.

Загружается спрайтовый FIFO из специальной служебной области OAM (та которая 32 байта), во время горизонтальной синхронизации (HBlank).

## Транзисторная схема

На транзисторных схемах показан только пайплайн для спрайта #0. Все остальные пайплайны отличаются только названием сигналов.

### Обратный счетчик

Показана схема для спрайта #0. Для всех остальных (1-7) нужно заменить название сигналов 0/EN на x/EN.

![fifo_counter_control](/BreakingNESWiki/imgstore/fifo_counter_control.jpg)

![fifo_counter](/BreakingNESWiki/imgstore/fifo_counter.jpg)

### Схема контроля пайплайна

Показана схема для спрайта #0. Для всех остальных (1-7) нужно заменить название сигналов 0/EN, 0/COL2, 0/COL3 и 0/PRIO на x/EN, x/COL2, x/COL3 и x/PRIO.

Кроме этого контрольные линии H3'', H4'' и H5'' используются следующим образом для разных пайплайнов:

|Номер спрайта (пайплайн)|Логика сигналов H3'', H4'' и H5''|
|---|---|
|0|H3'' H4'' H5''| 
|1|/H3'' H4'' H5''|
|2|H3'' /H4'' H5''|
|3|/H3'' /H4'' H5''|
|4|H3'' H4'' /H5''|
|5|/H3'' H4'' /H5''|
|6|H3'' /H4'' /H5''|
|7|/H3'' /H4'' /H5''|

![fifo_attr](/BreakingNESWiki/imgstore/fifo_attr.jpg)

### Спаренный сдвиговый регистр

Показана схема для спрайта #0. Для всех остальных (1-7) нужно заменить название сигналов 0/COL0 и 0/COL1 на x/COL0 и x/COL1.

![fifo_sr](/BreakingNESWiki/imgstore/fifo_sr.jpg)

TBD: На неподписанные транзисторы приходит сигнал `EN` со схемы контроля пайплайна.

### Схема приоритета спрайтов

Схема приоритета находится в "размазанном" виде. Ниже представлены отдельные куски этой схемы.
Предположительно схема работает по принципу мажоритарного элемента.

![fifo_prio0](/BreakingNESWiki/imgstore/fifo_prio0.jpg)

![fifo_prio1](/BreakingNESWiki/imgstore/fifo_prio1.jpg)

![fifo_prio2](/BreakingNESWiki/imgstore/fifo_prio2.jpg)

![fifo_prio3](/BreakingNESWiki/imgstore/fifo_prio3.jpg)

![fifo_prio4](/BreakingNESWiki/imgstore/fifo_prio4.jpg)

Результатом работы схемы (выходом) является сигнал `SPR0HIT`, который уходит в соотвтетствующую схему Sprite 0 Hit (см. [мультиплексор](mux.md))

### H. Inversion

![ppu_hinv](/BreakingNESWiki/imgstore/ppu_hinv.jpg)

HINV и HDIR - это два комплементарных сигнала (они никогда не могут принимать одинаковых значений). По сути эти два сигнала - это один управляющий сигнал мультиплексора, который выбирает между двумя разрядами шины PD. Если HINV = 1 - это означает что шина PD выдается в перевернутом виде на выходы T0-7. Если HDIR = 1 - это означает что шина PD выдается в прямом виде на выходы T0-7.

