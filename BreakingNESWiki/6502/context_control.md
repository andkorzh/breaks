# Управляющие команды

![6502_locator_controls](/BreakingNESWiki/imgstore/6502_locator_controls.jpg)

"Управляющие команды" - это условное название большого количества контрольных сигналов, которые идут с верхней части процессора в нижнюю и управляют контекстом (регистрами, шинами) и АЛУ.

![6502_controls_tran1](/BreakingNESWiki/imgstore/6502_controls_tran1.jpg)

![6502_controls_tran2](/BreakingNESWiki/imgstore/6502_controls_tran2.jpg)

![6502_controls_tran3](/BreakingNESWiki/imgstore/6502_controls_tran3.jpg)

![6502_controls_tran4](/BreakingNESWiki/imgstore/6502_controls_tran4.jpg)

Управляющие команды для регистра флагов рассматриваются в соответствующем разделе, посвященном [управлению флагами](flags_control.md), так как они не выходят за пределы верхней части процессора.

Каждый контрольный сигнал обычно содержит выходную защелку и иногда специальный транзистор-"отсекатель", который отключает сигнал в определенный полутакт (обычно часть сигналов отключается во время PHI2). Связано это с тем, что внутренние шины подзаряжаются во время PHI2, а регистры в это время обычно "рефрешатся".

Большинство сигналов имеют названия вида `A/B`, это значит что линия "соединяет" `A` с `B`. Например SB/X означает что значение с внутренней шины SB помещается на регистр X.

## Список управляющих сигналов

Более подробно все команды рассмотрены в соответствующих разделах. Сводная таблица просто для справки.

|Название|PHI1|PHI2|Описание|
|---|---|---|---|
|Команды управления регистрами||||
|Y/SB|√| |Y => SB|
|SB/Y|√| |SB => Y|
|X/SB|√| |X => SB|
|SB/X|√| |SB => X|
|S/ADL|√|√|S => ADL|
|S/SB|√|√|S => SB|
|SB/S|√| |SB => S|
|S/S|√| |Команда S/S активна, если неактивна команда SB/S. Эта команда просто "рефрешит" текущее состояние регистра S.|
|Команды управления АЛУ||||
|NDB/ADD|√| |~DB => BI|
|DB/ADD|√| |DB => BI|
|0/ADD|√| |0 => AI|
|SB/ADD|√| |SB => AI|
|ADL/ADD|√| |ADL => BI|
|/ACIN|√|√|Входной перенос АЛУ (в инверсной логике). Также АЛУ возвращает результат переноса `ACR` и переполнения `AVR`|
|ANDS|√|√|AI & BI|
|EORS|√|√|AI ^ BI|
|ORS|√|√|AI | BI|
|SRS|√|√|>>= 1|
|SUMS|√|√|AI + BI|
|/DAA|√|√|0: Выполнить коррекцию после сложения|
|/DSA|√|√|0: Выполнить коррекцию после вычитания|
|ADD/SB7|√|√|ADD\[7\] => SB\[7\]|
|ADD/SB06|√|√|ADD\[0-6\] => SB\[0-6\]|
|ADD/ADL|√|√|ADD => ADL|
|SB/AC|√| |SB => AC|
|AC/SB|√| |AC => SB|
|AC/DB|√| |AC => DB|
|Команды управления счетчиком инструкций (PC)||||
|#1/PC|√|√|0: Выполнить инкремент счетчика инструкций|
|ADH/PCH|√| |ADH => PCH|
|PCH/PCH|√| |Если не выполняется ADH/PCH, то выполняется эта команда (рефрешить PCH)|
|PCH/ADH|√|√|PCH => ADH|
|PCH/DB|√|√|PCH => DB|
|ADL/PCL|√| |ADL => PCL|
|PCL/PCL|√| |Если не выполняется ADL/PCL, то выполняется эта команда (рефрешить PCL)|
|PCL/ADL|√|√|PCL => ADL|
|PCL/DB|√|√|PCL => DB|
|Команды управления шинами||||
|ADH/ABH|√|√|ADH => ABH|
|ADL/ABL|√|√|ADL => ABL|
|0/ADL0, 0/ADL1, 0/ADL2|√|√|Сбросить часть разрядов шины ADL. Используется для установки вектора прерываний.|
|0/ADH0, 0/ADH17|√|√|Сбросить часть разрядов шины ADH|
|SB/DB|√|√|SB <=> DB, соединить две шины|
|SB/ADH|√|√|SB <=> ADH|
|Команды управления защелкой DL||||
|DL/ADL|√|√|DL => ADL|
|DL/ADH|√|√|DL => ADH|
|DL/DB|√|√|DL <=> DB|

## ADD/SB7

Будьте внимательны, все выходные значения являются инверсными значениями защелок, за исключением `ADD/SB7`.

## Подтяжка PHI2

В левой части находится небольшая схема для подтяжки PHI2 (который используется большим количеством транзисторов-отсекателей, поэтому должен быть достаточно мощным):

![phi2_pullup_tran](/BreakingNESWiki/imgstore/phi2_pullup_tran.jpg)

Никакой логической нагрузки она не несет, но выглядит круто.

## Приоритет выполнения команд

Хотя в реальном процессоре все команды "выполняются" одновременно, всё же можно наметить некоторый приоритет, который заложили разработчики.

Команды нижней части 6502, в порядке очередности исполнения:

PHI1 "Установка адреса и режима R/W":

- Загрузка на шины из DL: DL_DB, DL_ADL, DL_ADH
- Регистры на шину SB: Y_SB, X_SB, S_SB
- Сохранение флагов на шину DB: P_DB
- Сохранение ADD на SB/ADL: ADD_SB7, ADD_SB06, ADD_ADL
- Сохранение старого значения указателя стека на шину ADL: S_ADL
- Инкремент PC: n_1PC
- Сохранение PC на шины: PCL_ADL, PCH_ADH, PCL_DB, PCH_DB
- Генератор констант: Z_ADL0, Z_ADL1, Z_ADL2, Z_ADH0, Z_ADH17
- Мультиплексирование шин: SB_DB, SB_ADH
- Загрузка операндов АЛУ: NDB_ADD, DB_ADD, Z_ADD, SB_ADD, ADL_ADD
- BCD-коррекция через шину SB: SB_AC
- Сохранение AC: AC_SB, AC_DB
- Загрузка флагов: DB_P, DBZ_Z, DB_N, IR5_C, DB_C, IR5_D, IR5_I, DB_V, Z_V, ACR_C, AVR_V
- Загрузка регистров: SB_X, SB_Y, SB_S / S_S
- Загрузка PC с шин или хранение старого значения: ADH_PCH/PCH_PCH, ADL_PCL/PCL_PCL
- Сохранение DB на DOR
- Установка внешней шины адреса: ADH_ABH, ADL_ABL

PHI2 "Чтение/запись данных":

- Загрузка DL значением с внешней шины данных
- Регистры на шину SB: S_SB
- Сохранение флагов на шину DB: P_DB
- Операция на АЛУ: ANDS, EORS, ORS, SRS, SUMS, n_ACIN, n_DAA, n_DSA
- Сохранение ADD на SB/ADL: ADD_SB7, ADD_SB06, ADD_ADL
- Сохранение старого значения указателя стека на шину ADL: S_ADL
- Инкремент PC: n_1PC (в этом полуцикле происходит увеличение PC)
- Сохранение PC на шины: PCL_ADL, PCH_ADH, PCL_DB, PCH_DB
- Генератор констант: Z_ADL0, Z_ADL1, Z_ADL2, Z_ADH0, Z_ADH17
- Мультиплексирование шин: SB_DB, SB_ADH
- Загрузка флагов: DB_P, DBZ_Z, DB_N, IR5_C, DB_C, IR5_D, IR5_I, DB_V, Z_V, ACR_C, AVR_V
- Установка внешней шины данных из DOR: Если WR = 1
