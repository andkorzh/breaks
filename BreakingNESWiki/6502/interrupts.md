# Обработка прерываний

![6502_locator_intr](/BreakingNESWiki/imgstore/6502_locator_intr.jpg)

Обработка прерывания включает в себя следующие схемы:
- Детектирование фронта NMI
- Счетчик циклов 6-7 для обработки прерываний
- Установка младших разрядов адреса вектора прерывания (ADL0-3)
- Схема выдачи внутреннего сигнала `DORES`
- Флаг B

На вход схем приходят три сигнала `/NMIP`, `/IRQP` и `RESP` с соответствующих входных контактов.

## Обработка NMI

Транзисторная схема (включает счетчик циклов 6-7 и детектор фронта NMI):

![intr_cycles_nmip_tran](/BreakingNESWiki/imgstore/intr_cycles_nmip_tran.jpg)

## Установка вектора прерывания и Reset FF

Транзисторная схема:

![intr_resp_address_tran](/BreakingNESWiki/imgstore/intr_resp_address_tran.jpg)

Схема получения контрольного сигнала `DORES` ("Do Reset") (который разводится на все остальные внутренности) скомбинирована тут со схемой установки вектора прерывания для экономии места.

Логическая схема установки адреса прерывания:

![intr_address_logic](/BreakingNESWiki/imgstore/intr_address_logic.jpg)

## Флаг B

Транзисторная схема:

![intr_b_flag_tran](/BreakingNESWiki/imgstore/intr_b_flag_tran.jpg)

## Логическая схема

Схема обработки прерываний:

![int_control_logisim](/BreakingNESWiki/imgstore/logisim/int_control_logisim.jpg)

Схема для установки адреса обработчика прерывания:

![int_address_logisim](/BreakingNESWiki/imgstore/logisim/int_address_logisim.jpg)

Для обработки прерываний дополнительно требуется схема генерации 6 и 7 циклов (так как они не поступают с декодера) (контрольные сигналы `BRK6E` и `BRK7`). Причём контрольный сигнал BRK6E ("Break Cycle 6 End") начинается во время PHI2 6-го цикла и заканчивается во время PHI1 7-го цикла. Сделано это для того, чтобы определить фронт (edge) сигнала /NMI.

Определением фронта /NMI занимается классическая схема edge detect на базе двух RS-триггеров.

Сигнал /RES дополнительно сохраняется на RESET FLIP/FLOP, так как он требуется для других схем рандомной логики (в частности для особого управления контактом R/W).

Факт прихода любого прерывания отражается на флаге B, выход которого (`B_OUT`) принудительно заставляет процессор выполнить инструкцию BRK (код операции 0x00). Таким образом разрабочтики унифицировали обработку всех прерываний.

Последняя небольшая схема формирует адрес (или вектор) прерывания (контрольные сигналы 0/ADL0, 0/ADL1 и 0/ADL2), которые управляют младшими 3 разрядами шины адреса.
