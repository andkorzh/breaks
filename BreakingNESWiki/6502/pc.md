# Счетчик инструкций (PC)

![6502_locator_pc](/BreakingNESWiki/imgstore/6502_locator_pc.jpg)

Из-за 8-битной природы процессора его счетчик инструкций разделен на две 8-битные половины: PCL (Program Counter Low) и PCH (Program Counter High).

Кроме этого PCH также разделен на 2 половины: младшую часть разрядов (0-3) и старшую (4-7).

## PCL

Представляет собой младшие разряды PC\[0-7\].

|PCL 0-3|PCL 4-7|
|---|---|
|![pcl03_tran](/BreakingNESWiki/imgstore/pcl03_tran.jpg)|![pcl47_tran](/BreakingNESWiki/imgstore/pcl47_tran.jpg)|

- Схемы чередуются для четных и нечетных разрядов, так как используется оптимизация, известная как инвертированная цепочка переносов
- На разряд PCL0 приходит управляющий сигнал `#1/PC` (0: выполнить инкремент PC)
- PCLC (PCL Carry): Перенос с младших 8 разрядов (PC\[0-7\]) на старшие (PC\[8-15\])
- PCL соединяется с двумя шинами: ADL и DB
- PCL/PCL используется когда PCL не соединен ни с одной шиной (для поддержания текущего состояния)
- Каждый разряд содержит две защелки (входная защелка `PCLSx` и выходная защелка `PCLx`), которые реализуют логику счетчика

## PCH

Представляет собой старшие разряды PC\[8-15\].

|PCH 0-3|PCH 4-7|
|---|---|
|![pch03_tran](/BreakingNESWiki/imgstore/pch03_tran.jpg)|![pch47_tran](/BreakingNESWiki/imgstore/pch47_tran.jpg)|

Схема отмеченная как "patch" для формирования `PCHC` на самом деле находится между контрольными выходами `ADL/PCL` и `#1/PC`.

- Основные принципы устройства PCH повторяют PCL, только PCH разбит на 2 половины: младшую (PCH0-3) и старшую (PCH4-7)
- PCHC (PCH Carry): Перенос с младшей части PCH в старшую
- PCH соединяется с двумя шинами: ADH и DB
- PCH/PCH используется когда PCH не соединен ни с одной шиной (для поддержания текущего состояния)

## ADL/ADH Precharge

В промежутках между разрядами PC можно встретить транзисторы для подзарядки шин ADL и ADH:

![adl_adh_precharge_tran](/BreakingNESWiki/imgstore/adl_adh_precharge_tran.jpg)

(На изображении показаны precharge транзисторы для ADH4 и ADL5. Остальные аналогично)

## Логическая схема

Имеет смысл показать только схемы разрядов (схемы чередуются между четными и нечетными разрядами PCL/PCH).

Данная схема используется, например, в PCL0:

![pc_even_bit_logisim.jpg](/BreakingNESWiki/imgstore/pc_even_bit_logisim.jpg.jpg)

Данная схема используется, например, в PCL1:

![pc_odd_bit_logisim.jpg.jpg](/BreakingNESWiki/imgstore/pc_odd_bit_logisim.jpg.jpg)

Чтобы данные схемы корректно работали в симуляторе, FF для разряда регистра PCL/PCH использует триггер по заднему фронту (posedge).

Чтобы ещё более запутать читателя, приведем ещё один факт: чередование схем в PCH происходит не только между разрядами, но и сам порядок меняется на разряде PCH4.
