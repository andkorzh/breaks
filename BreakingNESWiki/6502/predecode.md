# Предварительное декодирование

![6502_locator_predecode](/BreakingNESWiki/imgstore/6502_locator_predecode.jpg)

Схема предназначена для определения "класса" инструкции: 
- Короткая инструкция, которая выполняется за 2 такта (`TWOCYCLE`)
- Инструкция типа `IMPLIED`, у которой нет операндов (занимает 1 байт в памяти)

![predecode_tran](/BreakingNESWiki/imgstore/predecode_tran.jpg)

Код операции полученный с внешней шины данных (D0...D7) сохраняется на защелке PREDECODE (PD) во время PHI2, после чего логика предекодирования сразу определяет класс инструкции (схема является комбинаторной).

Выход `/TWOCYCLE` используется коротким счетчиком тактов. Выход `/IMPLIED` используется логикой инкремента PC.

Значение которое хранится на защелке PD подается на вход [регистра инструкций](ir.md). (TBD: На транзисторной схеме неправильно нарисовано. На самом деле значение с защелки PD выдается в инвертированном виде на комбинаторную схему, а чтобы сделать его снова прямым для регистра инструкций - снова инвертируется. Поэтому на транзисторной схеме нужно поменять инверсность всех названий `PDx` и `/PDx`)

Также на вход Predecode логики подается управляющая линия `0/IR`, которая "инжектирует" в поток инструкций операцию BRK. Это происходит во время обработки прерываний, для инициализации BRK-последовательности (все прерывания просто имитируют инструкцию BRK, с небольшими изменениями).

Схема предварительного декодирования работает в тесном сотрудничестве с [диспатчером](dispatch.md), все контрольные сигналы уходят туда.

## Логическая схема

![predecode_logic](/BreakingNESWiki/imgstore/predecode_logic.jpg)

TBD: Раздеморганить схему, чтобы была больше похожа на транзисторную.

Логика предекодирования самоописательная:
- 2-х тактовые инструкции это: Инструкции с непосредственным операндом ИЛИ все однобайтовые инструкции КРОМЕ инструкций push/pull (задаются маской XXX010X1 + 1XX000X0 + XXXX10X0 - 0XX0XX0X)
- Однобайтовые инструкции задаются маской XXXX10X0

TWOCYCLE инструкции:

![predecode_twocycle](/BreakingNESWiki/imgstore/predecode_twocycle.jpg)

IMPLIED инструкции:

![predecode_implied](/BreakingNESWiki/imgstore/predecode_implied.jpg)
