# Предварительное декодирование

![6502_locator_predecode](/BreakingNESWiki/imgstore/6502/6502_locator_predecode.jpg)

Схема предназначена для определения "класса" инструкции: 
- Короткая инструкция, которая выполняется за 2 такта (`TWOCYCLE`)
- Инструкция типа `IMPLIED`, у которой нет операндов (занимает 1 байт в памяти)

![predecode_tran](/BreakingNESWiki/imgstore/predecode_tran.jpg)

Код операции полученный с внешней шины данных (D0...D7) сохраняется на защёлке PREDECODE (PD) во время PHI2 (в инвертированном виде), после чего логика предекодирования сразу определяет класс инструкции (схема является комбинаторной).

Выход `/TWOCYCLE` используется коротким счётчиком тактов. Выход `/IMPLIED` используется логикой инкремента PC.

Значение защёлки PD подается на вход [регистра инструкций](ir.md) в инвертированном виде.

Также на вход Predecode логики подается управляющая линия `0/IR`, которая "инжектирует" в поток инструкций операцию BRK. Это происходит во время обработки прерываний, для инициализации BRK-последовательности (все прерывания просто имитируют инструкцию BRK, с небольшими изменениями).

Схема предварительного декодирования работает в тесном сотрудничестве с [диспатчером](dispatch.md), все контрольные сигналы уходят туда.

## Логическая схема

На транзисторной схеме отмечены соответствующие вентили:

![predecode_tran_gates](/BreakingNESWiki/imgstore/predecode_tran_gates.jpg)

![predecode_logic](/BreakingNESWiki/imgstore/predecode_logic.jpg)

Логика предекодирования самоописательная:
- Двухтактовые инструкции это: Инструкции с непосредственным операндом ИЛИ все однобайтовые инструкции КРОМЕ инструкций push/pull (задаются маской XXX010X1 + 1XX000X0 + XXXX10X0 - 0XX0XX0X)
- Однобайтовые инструкции задаются маской XXXX10X0

TWOCYCLE инструкции:

![predecode_twocycle](/BreakingNESWiki/imgstore/predecode_twocycle.jpg)

IMPLIED инструкции:

![predecode_implied](/BreakingNESWiki/imgstore/predecode_implied.jpg)

## Оптимизированная логическая схема

![24_predecode_logic](/BreakingNESWiki/imgstore/6502/ttlworks/24_predecode_logic.png)
