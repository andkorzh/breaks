# АЛУ

![6502_locator_alu](/BreakingNESWiki/imgstore/6502_locator_alu.jpg)

Показать всю схему АЛУ не представляется возможным, поэтому распилим её на составные части и рассмотрим каждую по отдельности.

![alu_preview](/BreakingNESWiki/imgstore/alu_preview.jpg)

АЛУ состоит из следующих компонентов:
- Входные схемы для загрузки защелок AI/BI
- Основная вычислительная часть (Operations)
- Схема быстрого вычисления переноса для BCD 
- Промежуточный результат (защелка ADD)
- Схема BCD коррекции
- Аккумулятор (AC)

Вообще говоря, АЛУ представляет собой месиво из транзисторов и проводов, но его работа не очень сложная, в чем вы можете убедиться далее.

## Защелки AI/BI

Входные схемы состоят из 8 одинаковых кусков, которые предназначены для загрузки входных значений на защелки AI и BI:

![alu_input_tran](/BreakingNESWiki/imgstore/alu_input_tran.jpg)

(На картинке показана схема для разряда 0, остальные аналогично)

Контрольные сигналы:
- DB/ADD: Загрузить прямое значение с шины DB в защелку BI
- NDB/ADD: Загрузить инверсное значение с шины DB в защелку BI
- ADL/ADD: Загрузить значение с шины ADL в защелку BI
- SB/ADD: Загрузить значение с шины SB в защелку AI
- 0/ADD: Записать 0 в защелку AI

## Вычислительная часть

АЛУ использует инвертированную цепочку переносов, поэтому схемы четных и нечетных разрядов чередуются.

Разряд 0 немного отличается от остальных четных разрядов, так как на него приходит входной перенос (`/ACIN`). 

Схема для разряда 0:

![alu_bit0_tran](/BreakingNESWiki/imgstore/alu_bit0_tran.jpg)

Схемы для разрядов 1, 3, 5, 7:

![alu_bit_odd_tran](/BreakingNESWiki/imgstore/alu_bit_odd_tran.jpg)

(Показана схема для разряда 1, остальные аналогично)

Схемы для разрядов 2, 4, 6:

![alu_bit_even_tran](/BreakingNESWiki/imgstore/alu_bit_even_tran.jpg)

(Показана схема для разряда 2, остальные аналогично)

Анатомически левая часть занимается логическими операциями, в правой части находится сумматор (Full Adder), а по середине - цепочка переноса.

Обозначения на схемах:
- nand: промежуточный результат выполнения операции NAND для выбранного разряда
- and: промежуточный результат выполнения операции AND для выбранного разряда (получается инверсией `nand`)
- nor: промежуточный результат выполнения операции NOR для выбранного разряда
- xor: промежуточный результат выполнения операции EOR для выбранного разряда
- nxor: промежуточный результат выполнения операции ENOR для выбранного разряда
- carry: резултаты переполнения. Цепочка переносов инвертируется каждый разряд, но для упрощения все названия `carry` не учитывают инверсию значений.
- res: результат выполнения логической операции или результат сумматора, который потом сохраняется на защелке ADD. Результат операции в инвертированном виде.

Чтобы было понятней как получаются промежуточные результаты, на изображении ниже отмечены все основные мотивы:

![alu_bit_annotated_tran](/BreakingNESWiki/imgstore/alu_bit_annotated_tran.jpg)

На картинке выше показан разряд 1, для остальных разрядов мотив выглядит аналогично.

Вычисление переполнения:

![alu_avr_tran](/BreakingNESWiki/imgstore/alu_avr_tran.jpg)

Контрольные сигналы для операций АЛУ:
- ORS: Операция логического ИЛИ (AI | BI)
- ANDS: Операция логического И (AI & BI)
- XORS: Операция логического дополнения XOR (AI ^ BI)
- SRS: Сдвиг вправо. Для этого результат текущей операции `nand` сохраняется как результат предыдущего разряда.  
- SUMS: Суммирование (AI + BI)

## Быстрый перенос BCD

Именно эта схема фигурирует в патенте US 3991307 (https://patents.google.com/patent/US3991307A).

![alu_bcd_carry_tran1](/BreakingNESWiki/imgstore/alu_bcd_carry_tran1.jpg)

![alu_bcd_carry_tran2](/BreakingNESWiki/imgstore/alu_bcd_carry_tran2.jpg)

Схемы для удобства восприятия "положены на бок".

Как именно работает эта схема написано в патенте, мне добавить нечего.

## Промежуточный результат (ADD)

Промежуточный результат хранится на защелке ADD (хранится в инвертированном виде, выдается на шины в прямом виде). Схема защелки ADD состоит из 8 одинаковых кусков: 

![alu_add_tran](/BreakingNESWiki/imgstore/alu_add_tran.jpg)

(Показана схема для разряда 0, остальные аналогично)

- ADD/SB06: Поместить значение защелки ADD на шину SB. Для разряда 7 вместо ADD/SB06 используется контрольный сигнал `ADD/SB7`.
- ADD/ADL: Поместить значение защелки ADD на шину ADL

## BCD Коррекция

TBD: Подумать как лучше распилить схему и добавить.

## Аккумулятор (AC)

Аккумулятор состоит из 8 одинаковых кусков:

![alu_ac_tran](/BreakingNESWiki/imgstore/alu_ac_tran.jpg)

(Показана схема для разряда 3, остальные аналогично)

На вход аккумулятора поступает значение со схемы BCD коррекции или непосредственно с шины SB (зависит от номера разряда).

Кроме непосредственно выдачи аккумулятора на шины SB и DB в этом месте также выполняются другие операции с шинами, поэтому они рассматриваются также в этом разделе.

- SB/AC: Поместить значение с шины SB/схемы BCD коррекции в аккумулятор
- AC/SB: Поместить значение AC на шину SB
- AC/DB: Поместить значение AC на шину DB
- SB/DB: Соединить шину SB с шиной DB
- SB/ADH: Соединить шину SB с шиной ADH
- 0/ADH17: Принудительно записать 0 в разряды ADH\[1-7\]. Для разряда 0 вместо 0/ADH17 используется контрольный сигнал `0/ADH0`.
