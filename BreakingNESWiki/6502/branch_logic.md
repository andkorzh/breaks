# Логика условных переходов

![6502_locator_branch](/BreakingNESWiki/imgstore/6502/6502_locator_branch.jpg)

Логика условных переходов определяет:
- Произошел ли переход вперед или назад
- Произошел ли переход вообще

Направление перехода определяется по 7-му разряду операнда инструкции перехода (относительному смещению), который хранится на внутренней шине данных (DB). Если 7й разряд равен 1, то это значит что переход производится "назад" (PC = PC - offset).

Проверка перехода осуществляется в зависимости от инструкции перехода (которые отличаются 6 и 7 разрядами кода операции), а также от флагов: C, V, N, Z.

## Схема Branch Forward

![branch_forward_tran](/BreakingNESWiki/imgstore/branch_forward_tran.jpg)

Триггер BRFW обновляется значением D7 во время BR3.PHI1. В остальное время триггер хранит своё текущее значение. Значение триггера выдается как контрольный сигнал `BRFW` на схему [управления счетчиком инструкций (PC)](pc_control.md).

`BR2` - это выход декодера X80.

## Схема Branch Taken

![branch_taken_tran](/BreakingNESWiki/imgstore/branch_taken_tran.jpg)

Комбинаторная логика выбирает вначале по IR6/IR7 к какой группе принадлежит инструкция перехода (то есть какой флаг она проверяет), а последующий XOR выбирает каким образом инструкция перехода срабатывает (флаг установлен/сброшен). 
Выход `/BRTAKEN` в инверсной логике, то есть если переход сработал, то /BRTAKEN = 0. Потребителем сигнала /BRTAKEN также является схема управления PC.

Входы `/IR6` и `/IR7` являются выходами декодера X121 и X126 соответственно. Вход `/IR5` приходит непосредственно с [регистра инструкций](ir.md).

Примечание: логика Branch Taken работает постоянно и значение контрольной линии /BRTAKEN обновляется каждый цикл, в не зависимости от того, какая инструкция обрабатывается процессором в данный момент.

## Логическая схема

![branch_logic_logisim](/BreakingNESWiki/imgstore/logisim/branch_logic_logisim.jpg)
