# Контакты APU

Изучение любой микросхемы начинается с контактов.

|Наша вики|Официальные обозначения|
|---|---|
|![apu_pads](/BreakingNESWiki/imgstore/apu/apu_pads.jpg)|![apu_pinout_orig](/BreakingNESWiki/imgstore/apu/apu_pinout_orig.png)|

|Название|Номер|Направление|Описание|
|---|---|---|---|
|AUX A|1|APU =>|Выход ЦАП прямоугольных каналов|
|AUX B|2|APU =>|Выход ЦАП для остальных каналов (треугольный, шум и DPCM)|
|/RES|3|APU =>|Сигнал сброса|
|A0-A15|4-19|APU =>|Шина адреса|
|GND|20| |Земля|
|D0-D7|28-21|APU <=>|Шина данных|
|CLK|29|=> APU|Главный тактовый сигнал|
|DBG|30|=> APU|Отладочный режим (DBG=1: Включить отладочные регистры, DBG=0: Отключить отладочные регистры)|
|M2|31|APU =>|Модифицированный выход PHI2 ядра 6502|
|/IRQ|32|=> APU|Сигнал маскируемого прерывания|
|/NMI|33|=> APU|Сигнал немаскируемого прерывания|
|R/W|34|APU =>|Направление шины данных (R/W=1: чтение, R/W=0: запись)|
|/IN1|35|APU =>|Читать порт ввода-вывода, ассоциированный с регистром $4017|
|/IN0|36|APU =>|Читать порт ввода-вывода, ассоциированный с регистром $4016|
|OUT2|37|APU =>|Записать в порт ввода-вывода, ассоциированный с разрядом регистра $4016\[2\]|
|OUT1|38|APU =>|Записать в порт ввода-вывода, ассоциированный с разрядом регистра $4016\[1\]|
|OUT0|39|APU =>|Записать в порт ввода-вывода, ассоциированный с разрядом регистра $4016\[0\]|
|VCC|40| |Питание +5В|

## AUX A/B

Рассматриваются в разделе [ЦАП](dac.md).

## /RES

![pad_res](/BreakingNESWiki/imgstore/apu/pad_res.jpg)

Из внешнего сигнала `/RES` получается внутренний сигнал сброса `RES`. 

## A0-A15

![pad_a](/BreakingNESWiki/imgstore/apu/pad_a.jpg)

Значение с внутренней шины адреса непосредственно выдается на контакты A0-A15 (без буферизации). Во время сброса (`RES` = 1) - контакты A0-A15 отключены (`z`).

## D0-D7

![pad_d](/BreakingNESWiki/imgstore/apu/pad_d.jpg)

- `RD` и `WR` два комплементарных сигнала
- Когда `RD` равен 1 контакты D0-D7 работают как входные
- Когда `WR` равен 1 контакты D0-D7 работают как выходные

Соединение внутренней и внешней шин данных происходит напрямую (без буферизации).

## CLK

![pad_clk](/BreakingNESWiki/imgstore/apu/pad_clk.jpg)

## M2

![pad_m2](/BreakingNESWiki/imgstore/apu/pad_m2.jpg)

Схема для получения сигнала `NotDBG_RES`:

![notdbg_res_tran](/BreakingNESWiki/imgstore/apu/notdbg_res_tran.jpg)

По какой-то причине схема содержит отключенную "гребенку" транзисторов, которая представляет собой цепочку инверторов внутреннего сигнала `RES`.

В режиме отладки (когда DBG=1) - во время сброса внешний сигнал M2 не трогается. В обычном режиме (для Retail консолей) - во время сброса внешний сигнал M2 в состоянии `z` (Open-drain).

## DBG

![pad_dbg](/BreakingNESWiki/imgstore/apu/pad_dbg.jpg)

## /IRQ

![pad_irq](/BreakingNESWiki/imgstore/apu/pad_irq.jpg)

Устройство логики данного контакта немного избыточно. Значение входного терминала /IRQ формирует значение внутреннего сигнала /IRQ (с таким же названием).

## /NMI

![pad_nmi](/BreakingNESWiki/imgstore/apu/pad_nmi.jpg)

Устройство контакта /NMI не отличается от устройства терминала /IRQ.

## R/W

![pad_rw](/BreakingNESWiki/imgstore/apu/pad_rw.jpg)

Выходное значение контакта R/W получается из внутреннего сигнала `RW`, при этом во время сброса R/W отключен (когда контакт /RES = 0 и внутренняя линия RES = 1), то есть имеет значение Z (high-impedance).

Контролирует отключение контакта R/W небольшая tri-state логика.

Некоторая часть push/pull инверторов, используемая для задержки линии R/W отключена. Видимо разработчики настраивали propagation delay для срабатывания сигнала.
Эта же самая линия задержки немного замедляет внутренний сигнал R/W.

## Порты ввода-вывода (IN/OUT)

|/INx|OUTx|
|---|---|
|![pad_in](/BreakingNESWiki/imgstore/apu/pad_in.jpg)|![pad_out](/BreakingNESWiki/imgstore/apu/pad_out.jpg)|

Устройство не отличается от устройства терминалов D0-D7, за исключением того, что аналогом сигнала `RD` является внутренний сигнал сброса (`RES`), а аналог сигнала `WR` всегда подключен к VCC (равен 1, т.е. контакт всегда работает наружу).

Во время сброса (RES = 1) терминалы In/Out отключены. Во время сброса схема терминала работает аналогично схеме терминалов D0-D7, при этом RD = WR = 1, а такое значение сигналов отключает терминал (`z`).

- Выходное значение для контактов `OUT0-2` получается из внутренних сигналов `OUT0-2` (с таким же названием).
- Выходное значение для контактов `/IN0-1` - это внутренние сигналы `/R4016` и `/R4017` с селектора регистров.

Схема для формирования сигналов OUTx:

![out_tran](/BreakingNESWiki/imgstore/apu/out_tran.jpg)

![OUT_Ports](/BreakingNESWiki/imgstore/apu/OUT_Ports.jpg)

![IORegBit](/BreakingNESWiki/imgstore/apu/IORegBit.jpg)

## Схемы

Действительно однонаправленные терминалы:

![Pads1](/BreakingNESWiki/imgstore/apu/Pads1.jpg)

Терминалы использующие BIDIR схему:

![Pads2](/BreakingNESWiki/imgstore/apu/Pads2.jpg)

Как уже говорилось, полностью все возможности двунаправленного терминала использует только шина данных. Остальные пады основанные на схеме BIDIR избыточны.

Схема BIDIR пада:

![BIDIR_Pad](/BreakingNESWiki/imgstore/apu/BIDIR_Pad.jpg)
