# Генератор тайминга

![apu_locator_clkgen](/BreakingNESWiki/imgstore/apu/apu_locator_clkgen.jpg)

Генератор тайминга содержит в своем составе следующие компоненты:
- Генератор ACLK
- Программный таймер (известный также как `Frame Counter`)
- По совместительству реализует Daisy-chain проброс прерывания от DPCM и подмешивание при необходимости своего прерывания от таймера

## Clock Distribution

Ниже приведены отличительные особенности разводки тактовых сигналов APU.

![2A03_ACLK_Distrib_sm](/BreakingNESWiki/imgstore/apu/2A03_ACLK_Distrib_sm.png)

|Особенность|Описание|
|---|---|
|1|Сигнал /CLK с пада CLK для делителя|
|2|Делитель, для получения тактового сигнала PHI0 для ядра|
|3|Тактовый сигнал PHI0 (CLK ÷ 12)|
|4|Тактовый сигнал PHI1 ("левая" половина цикла CPU: "Установить режим Read/Write и адрес")|
|5|Тактовый сигнал PHI2 ("правая" половина цикла CPU: "Чтение/запись данных")|
|6|Сигнал PHI2 для модуляции скважности сигнала M2|
|7|Сигнал M2 для внешних устройств|
|8|Сигнал PHI1 для регистровых операций (регистровые операции неактивны во время PHI1)|
|9|Выход сигналов ACLK и /ACLK с генератора ACLK (PHI ÷ 2)|
|10|Выход сигналов низкочастотной осцилляции /LFO1 и /LFO2 для звуковых генераторов|
|11|Сигнал PHI1 дополнительно используется треугольным каналом для сглаживания "ступенек" сигнала|
|12|"Другие /ACLK"|

Изображение в полном размере: https://github.com/emu-russia/breaks/blob/master/Docs/APU/2A03_ACLK_Distrib.png

Упрощённая диаграмма:

![apu_clocks](/BreakingNESWiki/imgstore/apu/apu_clocks.png)

## Генератор ACLK

Генератор ACLK используется для формирования внутреннего тактового сигнала ACLK (APU CLK), на базе тактовой частоты 6502 CPU.

![aclk_gen_tran](/BreakingNESWiki/imgstore/apu/aclk_gen_tran.jpg)

![ACLK_Gen](/BreakingNESWiki/imgstore/apu/ACLK_Gen.jpg)

Сигналы `ACLK` и `/ACLK` не комплементарны и имеют перекрытие:

![aclk](/BreakingNESWiki/imgstore/apu/waves/aclk.png)

|APU|Частота кварца|CLK|PHI|ACLK|
|---|---|---|---|---|
|2A03|21477272 Hz|~46.56 ns|~558.73 ns|~1117.46 ns|
|2A07|26601712 Hz|~37.59 ns|~601.46 ns|~1202.93 ns|

## Программный таймер

Из официальной документации известно что этот компонент называется `Soft CLK`.

Назначение этого устройства заключается в снабжении программиста инструментом для добавления периодичных действий в игровую программу, повторяющихся примерно каждый кадр.

Возможности Soft CLK:
- Режимы работы (обычный и расширенный)
- Генерирование прерываний
- Тактирование остальных тональных генераторов APU низкочастотными сигналами (`/LFO1`, `/LFO2`)

![SoftCLK](/BreakingNESWiki/imgstore/apu/SoftCLK.jpg)

### Программная модель

Soft CLK управляется регистром $4017 (write-only):
- $4017\[6\]: Маскирует прерывание SoftCLK (1: interrupt disable, 0: enable)
- $4017\[7\]: Режим LFO (0: обычный режим, 1: расширенный режим)

Разряд регистра $4015\[6\] содержит статус прерывания.

### Управление Soft CLK

![softclk_control_tran](/BreakingNESWiki/imgstore/apu/softclk_control_tran.jpg)

- /R4015 и W4017: приходят из селектора регистров при чтении $4015 и записи в $4017 регистры соответственно
- D6 и D7: 6й и 7й биты внутренней шины данных
- /LFO1 и /LFO2: выходные низкочастотные сигналы
- DMCINT: прерывание от DPCM
- INT: общий сигнал прерывания от Soft CLK или DPCM
- RES: внутренний сигнал сброса (получается из контакта /RES)

Управление счётчиком:

![softclk_counter_control_tran](/BreakingNESWiki/imgstore/apu/softclk_counter_control_tran.jpg)

Логика:

![SoftCLK_Control](/BreakingNESWiki/imgstore/apu/SoftCLK_Control.jpg)

|Частота сигналов LFO|Mode=0|Mode=1|Куда роутится сигнал|
|---|---|---|---|
|LFO1|~240 Hz|~192 Hz|Square 0/1, Noise, Triangle|
|LFO2|~120 Hz|~96 Hz|Square 0/1, Length Counters|

### Счётчик Soft CLK (LFSR)

![softclk_counter_tran](/BreakingNESWiki/imgstore/apu/softclk_counter_tran.jpg)

![SoftCLK_SR](/BreakingNESWiki/imgstore/apu/SoftCLK_SR.jpg)

![SoftCLK_SRBit](/BreakingNESWiki/imgstore/apu/SoftCLK_SRBit.jpg)

Выходы регистра сдвига (в комплементарном виде) подаются на вход декодера (PLA).

### PLA

```
111110
000001
011100
100011
000110
111001
000100
111011
001100
110011
100000
011111
101000
010111
001010
110101
000010
111101
010100
101011
011000
100111
001100
110011
110010
001101
011010
100101
000010
111101
```

Размещение топологическое. 1 - означает есть транзистор, 0 - означает нет транзистора.

![SoftCLK_PLA](/BreakingNESWiki/imgstore/apu/SoftCLK_PLA.jpg)

Особенности использования PLA:
- Выход 3 используется для генерации прерывания и одновременно пропускается в Mode=1. Поэтому прерывания доступны только в Mode=0
- Выход 4 используется только в Mode=1
- Выход 5 используется для защиты от значения 0 на LFSR и не влияет на формирование сигналов LFO
- Активация выходов PLA, которые участвуют в формировании сигналов LFO происходит по очереди (0,1,2,3 для Mode=0 и 0,1,2,4 для Mode=1)

Таблица последовательности активации выходов PLA и длительности между срабатываниями (количество циклов PHI1):

|NTSC 2A03|||||
|---|---|---|---|---|
|nLFO1  mode4|PLA0   (7457 )|PLA1 (7457 )|PLA2 (7457 )|PLA3  (7457 )  (SET LFSR)|
|nLFO2  mode4|no|PLA1 (14913)|no|PLA3  (14913) (SET LFSR)|
|nLFO1  mode5|PLA0   (7457 )|PLA1 (7457 )|PLA2 (7457 )|PLA4  (14913) (SET LFSR)|
|nLFO2  mode5|no|PLA1 (14913)|no|PLA4  (22367) (SET LFSR)|

|PAL 2A07|||||
|---|---|---|---|---|
|nLFO1 mode4|PLA0  (8313)|PLA1 (8313)|PLA2 (8313)|PLA3  (8313)   (SET LFSR)|
|nLFO2 mode4|no|PLA1 (16625)|no|PLA3  (16625) (SET LFSR)|
|nLFO1 mode5|PLA0  (8313)|PLA1 (8313)|PLA2 (8313)|PLA4  (16625) (SET LFSR)|
|nLFO2 mode5|no|PLA1 (16625)|no|PLA4  (24939) (SET LFSR)|

(в таблице не учитывается незначительно плавающее количество циклов для последнего выхода)

## Другие /ACLK

Кое-где в разных частях APU находятся так называемые "другие" /ACLK.

Вначале был обнаружен "другой" /ACLK в схеме DPCM/DMA, но потом оказалось что они встречаются и в других частях APU. Поэтому эти сигналы называются по очередности 2, 3, 4 итд.

На схемах знаком :warning: отмечены места, где используется другие `/ACLK`.

### /ACLK2

В самом центре схемы DPCM находится схема, для получения "другого" /ACLK, который используется в [DPCM](dpcm.md), а также в [спрайтовой DMA](dma.md).
Этот сигнал можно встретить в наших схемах под названием `/ACLK2`.

![nACLK2](/BreakingNESWiki/imgstore/apu/nACLK2.jpg)

### /ACLK3

Используется для [прямоугольных генераторов звука](square.md), а более конкретно для регистров $4002/$4003/$4006/$4007.

![nACLK3](/BreakingNESWiki/imgstore/apu/nACLK3.jpg)

Для первого прямоугольного канала (Square 0 = A) сигнал называется `/ACLK3A`.

Для второго прямоугольного канала (Square 1 = B) сигнал называется `/ACLK3B`.

Но на общей схеме для двух каналов сигнал обозначен просто как `/ACLK3`.

### /ACLK4

Используется в [генераторе шума](noise.md) и схеме контроля [счётчиками длительности](length.md).

![nACLK4](/BreakingNESWiki/imgstore/apu/nACLK4.jpg)

### /ACLK5

Используется в I/O защёлках, которые формируют сигналы OUTx для соответствующих выходных терминалов.

![nACLK5](/BreakingNESWiki/imgstore/apu/nACLK5.jpg)
