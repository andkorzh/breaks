# Генератор тайминга

![apu_locator_clkgen](/BreakingNESWiki/imgstore/apu/apu_locator_clkgen.jpg)

Генератор тайминга содержит в своем составе следующие компоненты:
- Генератор ACLK
- Программный таймер (известный также как `Frame Counter`)

## Генератор ACLK

Генератор ACLK используется для формирования внутреннего тактового сигнала ACLK (APU CLK), на базе тактовой частоты 6502 CPU.

![aclk_gen_tran](/BreakingNESWiki/imgstore/apu/aclk_gen_tran.jpg)

![ACLK_Gen](/BreakingNESWiki/imgstore/apu/ACLK_Gen.jpg)

Сигналы `ACLK` и `/ACLK` не комплементарны и имеют перекрывание:

![aclk](/BreakingNESWiki/imgstore/apu/waves/aclk.png)

## Программный таймер

Из официальной документации известно что этот компонент называется `Soft CLK`.

Назначение этого устройства заключается в снабжении программиста инструментом для добавления периодичных действий в игровую программу, повторяющихся примерно каждый кадр.

Возможности Soft CLK:
- Режимы работы (обычный и расширенный)
- Генерирование прерываний
- Тактирование остальных тональных генераторов APU низкочастотными сигналами (`/LFO1`, `/LFO2`)

![SoftCLK](/BreakingNESWiki/imgstore/apu/SoftCLK.jpg)

### Программная модель

Soft CLK управляется регистром $4017 (write-only):
- $4017\[6\]: Маскирует прерывание (1: interrupt disable, 0: enable)
- $4017\[7\]: Запись в этот бит выбирает режим (0: обычный режим, 1: расширенный режим)

Разряд регистра $4015\[6\] содержит статус прерывания.

### Управление Soft CLK

![softclk_control_tran](/BreakingNESWiki/imgstore/apu/softclk_control_tran.jpg)

- /R4015 и W4017: приходят из селектора регистров при чтении $4015 и записи в $4017 регистры соответственно
- D6 и D7: 6й и 7й биты внутренней шины данных
- /LFO1 и /LFO2: выходные низкочастотные сигналы
- DMCINT: прерывание от DPCM
- INT: общий сигнал прерывания от Soft CLK или DPCM
- RES: внутренний сигнал сброса (получается из контакта /RES)

### Счётчик Soft CLK

Представляет собой счётчик Джонсона с обратной связью.

![softclk_counter_tran](/BreakingNESWiki/imgstore/apu/softclk_counter_tran.jpg)

![SoftCLK_SR](/BreakingNESWiki/imgstore/apu/SoftCLK_SR.jpg)

![SoftCLK_SRBit](/BreakingNESWiki/imgstore/apu/SoftCLK_SRBit.jpg)

Особенностью является инверсный вход для регистра сдвига. Выходы регистра сдвига (в комплементарной форме) подаются на вход декодера (PLA).

### Управление счётчиком Soft CLK

![softclk_counter_control_tran](/BreakingNESWiki/imgstore/apu/softclk_counter_control_tran.jpg)

### PLA

|Ряд|
|---|
|111110|
|000001|
|011100|
|100011|
|000110|
|111001|
|000100|
|111011|
|001100|
|110011|
|100000|
|011111|
|101000|
|010111|
|001010|
|110101|
|000010|
|111101|
|010100|
|101011|
|011000|
|100111|
|001100|
|110011|
|110010|
|001101|
|011010|
|100101|
|000010|
|111101|

Размещение топологическое. 1 - означает есть транзистор, 0 - означает нет транзистора.

## Другие /ACLK

Кое-где в разных частях APU находятся так называемые "другие" /ACLK.

Вначале был обнаружен "другой" /ACLK в схеме DPCM/DMA, но потом оказалось что они встречаются и в других частях APU. Поэтому эти сигналы называются по очередности 2, 3, 4 итд.

На схемах знаком :warning: отмечены места, где используется другие `/ACLK`.

### /ACLK2

В самом центре схемы DPCM находится схема, для получения "другого" /ACLK, который используется в [DPCM](dpcm.md), а также в [спрайтовой DMA](dma.md). Данный сигнал /ACLK отличается от обычного небольшой задержкой.
Этот сигнал ещё можно встретить в наших схемах под названием `/ACLK2`.

![nACLK2](/BreakingNESWiki/imgstore/apu/nACLK2.jpg)

### /ACLK3

Используется для [прямоугольных генераторов звука](square.md), а более конкретно для регистров $4002/$4003.

![nACLK3](/BreakingNESWiki/imgstore/apu/nACLK3.jpg)

Для первого прямоугольного канала (Square 0 = A) сигнал называется `/ACLK3A`.

Для второго прямоугольного канала (Square 1 = B) сигнал называется `/ACLK3B`.

Но на общей схеме для двух каналов сигнал обозначен просто как `/ACLK3`.

### /ACLK4

Используется в [генераторе шума](noise.md) и схеме контроля [счётчиками длительности](length.md).

![nACLK4](/BreakingNESWiki/imgstore/apu/nACLK4.jpg)

### /ACLK5

Используется в I/O защёлках, которые формируют сигналы OUTx для соответствующих выходных терминалов.

![nACLK5](/BreakingNESWiki/imgstore/apu/nACLK5.jpg)
