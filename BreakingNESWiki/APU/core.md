# Интеграция ядра 6502

![apu_locator_core](/BreakingNESWiki/imgstore/apu/apu_locator_core.jpg)

В данном разделе описаны особенности ядра и окружающей его вспомогательной логики, предназначенной для интеграции с остальными компонентами.

В состав ядра 6502 и окружающей его логики входят следующие сущности:
- Главный тактовый сигнал и делитель частоты
- Привязка контактов ядра 6502 к остальной части APU
- Ядро 6502

## Сигналы

|Сигнал|Откуда|Куда|Описание|
|---|---|---|---|
|CLK|CLK Pad|Divider|Входной CLK|
|/M2|Divider|M2 Pad|Промежуточный сигнал для терминала M2 (инверсная полярность)|
|DBG|DBG Pad|Test|1: Включение тестового режима. В 2A03 становятся доступны отладочные регистры. В 2A07 преобразуется в сигнал RDY2 (DBG=1 -> RDY2=0), по сути выполняет роль отладочного WAIT|
|NotDBG_RES|Test|M2 Pad|Промежуточный сигнал для управления терминалом M2 в условиях сброса и тестового режима|
|RES|/RES Pad|All|Глобальный сигнал сброса. Разводится практически по всем углам APU|
|R/W|CPU Core|DMABuffer, Reg Select, OAM DMA, DPCM DMA|Терминал ядра 6502. В применении к DMA используется для детектирования цикла чтения CPU, для корректной установки терминала RDY|
|/NMI|/NMI Pad|CPU Core|С терминала /NMI сигнал уходит практически сразу в ядро (не считая промежуточных инверторов)|
|INT|SoftCLK|IRQ Combine|Комбинированное прерывание DPCM и Timer из SoftCLK, который выполняет роль Daisy Chain посредника для прерывания DPCM|
|/IRQ|/IRQ Pad|IRQ Combine|Сигнал внешнего прерывания комбинируется с сигналом INT из SoftCLK|
|/IRQ_INT|IRQ Combine|CPU Core|Комбинированный сигнал прерывания для ядра|
|PHI0|Divider|CPU Core|Базовый тактовый сигнал для ядра|
|PHI1|CPU Core|SoftCLK, Triangle|Первая половина цикла ядра|
|PHI2|CPU Core|SoftCLK|Вторая половина цикла ядра|
|RW|DMABuffer|R/W Pad|Управление внешним терминалом R/W производится схемой DMABuffer|
|WR|DMABuffer|External DataBus Pads|1: Режим записи для терминалов внешней шины данных|
|RD|DMABuffer|External DataBus Pads|1: Режим чтения для терминалов внешней шины данных|
|RDY|OAM DMA|CPU Core|Сигнал готовности для ядра. Управление готовностью ядра производится схемой OAM DMA|
|RDY2|Test|CPU Core|Дополнительный тестовый сигнал готовности ядра. В 2A03 всегда равен 1. В 2A07 им можно управлять снаружи, используя DBG Pad|
|SPR/PPU|OAM DMA|DMABuffer|Режим работы DMABuffer (1: Запись в регистр $2004, 0: Чтение очередного байта для OAM DMA из памяти)|
|/DBGRD|Reg Select|DMABuffer|0: Производится чтение регистра APU и при этом включен тестовый режим (терминал DBG=1)|
|CPU_A\[15:0\]|CPU Core|Reg Predecode, Address Mux|Шина адреса ядра 6502. Участвует в выборе адресного пространства регистров APU и для мультиплексирования адреса|
|A\[15:0\]|Address Mux|External Address Pads|Выходное значение с адресного мультиплексора для терминалов AB. Также участвует в выборе конкретного регистра APU|
|D\[7:0\]|Internal DataBus|External DataBus Pads|Внутренняя шина данных, к которой также подключено ядро 6502|

Как видно сигналы, связанные с ядром очень лихо закручены. Да, эта часть в APU самая замороченная, в звуковых генераторах всё горадо проще и прямолинейнее.

## Делитель частоты

Делитель представляет собой счётчик Джонсона.

![div](/BreakingNESWiki/imgstore/apu/div.jpg)

(Для удобства схема положена "на бок").

Схема общего плана:

![div_logisim](/BreakingNESWiki/imgstore/apu/div_logisim.jpg)

Схема для 2A03:

![DIV_2A03](/BreakingNESWiki/imgstore/apu/DIV_2A03.jpg)

Разряд регистра сдвига делителя:

![DIV_SRBit](/BreakingNESWiki/imgstore/apu/DIV_SRBit.jpg)

## Соединение 6502 и APU

В данном разделе рассматриваются соединения контактов ядра 6502 с APU.

### /NMI и /IRQ

Вспомогательная логика для обработки NMI и IRQ:

|Схема|Описание|
|---|---|
|![apu_core_irqnmi_logic1](/BreakingNESWiki/imgstore/apu/apu_core_irqnmi_logic1.jpg)|Просто промежуточные инвертеры|
|![apu_core_irqnmi_logic2](/BreakingNESWiki/imgstore/apu/apu_core_irqnmi_logic2.jpg)|/IRQ_INT: Комбинация внешнего или внутреннего прерывания.|

Терминал /NMI:

![apu_core_nmi](/BreakingNESWiki/imgstore/apu/apu_core_nmi.jpg)

Терминал /IRQ:

![apu_core_irq](/BreakingNESWiki/imgstore/apu/apu_core_irq.jpg)

### RDY

![apu_core_rdy](/BreakingNESWiki/imgstore/apu/apu_core_rdy.jpg)

Рядом со входом RDY есть ещё один транзистор, который в NTSC APU всегда открыт (RDY2=1). В PAL APU вместо константного сигнала RDY2 используется сигнал /DBG (инверсия сигнала с внешнего терминала DBG).

### /RES

![apu_core_res](/BreakingNESWiki/imgstore/apu/apu_core_res.jpg)

На входе терминала /RES находится инвертер, чтобы инвертировать внутренний сигнал `RES`.

### PHI0, PHI1, PHI2

Генерация внутренних сигналов PHI:

![apu_core_phi_internal](/BreakingNESWiki/imgstore/apu/apu_core_phi_internal.jpg)

Генерация внешних сигналов PHI:

|PHI1|PHI2|
|---|---|
|![apu_core_phi1_ext](/BreakingNESWiki/imgstore/apu/apu_core_phi1_ext.jpg)|![apu_core_phi2_ext](/BreakingNESWiki/imgstore/apu/apu_core_phi2_ext.jpg)|

Ничего необычного.

### SO

![apu_core_so](/BreakingNESWiki/imgstore/apu/apu_core_so.jpg)

Терминал SO всегда подсоединен к `1`. Технически это нормально, т.к. на входе SO находится falling edge detector.

### R/W

![apu_core_rw](/BreakingNESWiki/imgstore/apu/apu_core_rw.jpg)

Ничего необычного.

Сигнал `RW` приходит не напрямую с терминала `R/W` ядра 6502, а получается в схеме буфера для спрайтовой DMA (см. ниже).

### SYNC

Контакт SYNC ни с чем не соединен (floating):

![apu_core_sync](/BreakingNESWiki/imgstore/apu/apu_core_sync.jpg)

### D0-D7

Контакты ядра 6502 соединяются напрямую с внутренней шиной данных D0-D7.

Схема сигнала `RD`:

![rd_tran](/BreakingNESWiki/imgstore/apu/rd_tran.jpg)

Буфер для спрайтовой DMA:

![sprbuf_tran](/BreakingNESWiki/imgstore/apu/sprbuf_tran.jpg)

Не очень к месту, но сказать придется именно в этом месте, т.к. кроме хранения данных для спрайтовой DMA данная схема также занимается получением сигнала `WR` для контактов внешней шины данных, а также сигнала `RW`.

:warning: Так получилось, что сигнал ядра 6502 `R/W` по названию очень похож на сигнал `RW`, который уходит на внешний контакт R/W. Не перепутайте :smiley:

![RWDecode](/BreakingNESWiki/imgstore/apu/RWDecode.jpg)

### A0-A15

Выходы шины адреса ядра 6502 ассоциированы с внутренними сигналами CPU_A0-15.

Для CPU_A14 дополнительно имеется инвертер, который используется в схеме предекодирования адреса регистров APU.

## Встроенное ядро 6502

Внешне ядро 6502 выглядит как копи-паста исходного процессора MOS в уменьшенном варианте.

После детального изучения схемы 2A03 были получены следующие результаты:
- Отличий в декодере не обнаружено
- Флаг D работает как обычно, его можно установить или сбросить, он используется нормальным образом при обработке прерываний (сохраняется в стеке) и после выполнения инструкций PHP/PLP, RTI.
- Рандомная логика отвечающая за генерацию двух контрольных сигналов `/DAA` (decimal addition adjust) и `/DSA` (decimal subtraction adjust) работает обычным образом.

Отличие заключается в том, что контрольные сигналы `/DAA` и `/DSA`, отвечающие за включение схем коррекции, отсоединены от схемы, путём вырезания 5 кусочков полисиликона (см. картинку). Полисиликон обозначен фиолетовым цветом, вырезанные кусочки обозначены голубым, а места обведены красным.

|Оригинальное изображение схемы 6502|Места с отсутствующим поли в APU|
|---|---|
|![bcd_tran_orig](/BreakingNESWiki/imgstore/apu/bcd_tran_orig.png)|![bcd_tran_apu_missing](/BreakingNESWiki/imgstore/apu/bcd_tran_apu_missing.png)|

Это приводит к тому, что схема вычисления десятичного переноса при сложении и схема добавления/отнимания 6 к результату - не работают. Поэтому встроенный процессор APU всегда считает двоичными числами, даже если флаг D установлен.

Процесс исследования: http://youtu.be/Gmi1DgysGR0

Ключевые узлы по которым был проведен анализ (декодер, рандомная логика, флаги и АЛУ) представлена на следующем изображении:

![2a03_6502_diff_sm](/BreakingNESWiki/imgstore/apu/2a03_6502_diff_sm.jpg)

Чтобы понять больше суть различий в работе BCD-схемы, рекомендуется изучить устройство [АЛУ 6502](/BreakingNESWiki/6502/alu.md).
